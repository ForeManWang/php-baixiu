# ç®¡ç†åå°åˆ é™¤æ–‡ç« 

åœ¨ `admin` ç›®å½•ä¸‹æ–°å»ºä¸€ä¸ª `post-delete.php` æ–‡ä»¶ï¼Œä¸“é—¨å¤„ç†æ–‡ç« çš„åˆ é™¤ä¸šåŠ¡ã€‚

<!-- çº¦å®šè¿™ä¸ªé¡µé¢å¤„ç†ä¸¤ç§ç±»å‹çš„åˆ é™¤ä¸šåŠ¡ï¼š

1. å•æ¡åˆ é™¤ï¼Œæ¥æ”¶è¦åˆ é™¤çš„æ–‡ç«  ID
2. æ‰¹é‡åˆ é™¤ï¼Œæ¥æ”¶ä»¥é€—å·åˆ†éš”çš„å¤šæ¡æ–‡ç«  ID å­—ç¬¦ä¸² -->

## å¤„ç†æµç¨‹

```flow
s=>start: è¯·æ±‚å¼€å§‹
c1=>condition: GET å‚æ•°ä¸­æ˜¯å¦æœ‰ id å‚æ•°
o1=>operation: æ¥æ”¶ GET å‚æ•°ä¸­çš„ id
o2=>operation: å°†æ¥æ”¶åˆ°çš„ id æ‹¼æ¥ä¸€ä¸ªåˆ é™¤ SQL è¯­å¥
o3=>operation: æ‰§è¡Œ SQL è¯­å¥ï¼Œåˆ é™¤å¯¹åº”æ•°æ®
o4=>operation: è·³è½¬åˆ°æ¥æºé¡µé¢
e=>end: è¯·æ±‚ç»“æŸ

s->c1
c1(yes)->o1->o2->o3->o4->e
c1(no)->o4->e
```

------

## å•æ¡åˆ é™¤

### æ¥æ”¶å‚æ•°

```php
if (!empty($_GET['id'])) {
  // æ¥æ”¶åˆ°è¦åˆ é™¤çš„ ID
}
```

### SQL è¯­å¥

```php
delete from posts where id in (' . $id . ');`
```

### æ‰§è¡Œ SQL è¯­å¥

ç”±äºä¹‹å‰å°è£…çš„ `xiu_fetch_all()`å’Œ`xiu_fetch_one` å‡½æ•°åªé€‚ç”¨äºæŸ¥è¯¢æ“ä½œï¼Œå¯¹äºå¢åˆ æ”¹ä¸€ç±»éæŸ¥è¯¢çš„æ“ä½œè¿˜æ˜¯éœ€è¦é‡æ–°å°è£…ä¸€ä¸ªå‡½æ•°ï¼Œå…·ä½“ä»£ç å¦‚ä¸‹ï¼š

```php
/**
 * æ‰§è¡Œä¸€ä¸ªå¢åˆ æ”¹è¯­å¥
 */
  function xiu_execute ($sql) {
    $conn = mysqli_connect(XIU_DB_HOST, XIU_DB_USER, XIU_DB_PASS, XIU_DB_NAME);
    if (!$conn) {
      exit('è¿æ¥å¤±è´¥');
    }

    $query = mysqli_query($conn, $sql);
    if (!$query) {
      // æŸ¥è¯¢å¤±è´¥
      return false;
    }

    // å¯¹äºå¢åˆ ä¿®æ”¹ç±»çš„æ“ä½œéƒ½æ˜¯è·å–å—å½±å“è¡Œæ•°
    $affected_rows = mysqli_affected_rows($conn);

    mysqli_close($conn);

    return $affected_rows;
  }
```

### é€šè¿‡ `xiu_execute()` å‡½æ•°æ‰§è¡Œ SQL è¯­å¥

```php
if (!empty($_GET['id'])) {
  // æ‹¼æ¥ SQL å¹¶æ‰§è¡Œ
  xiu_execute(sprintf('delete from posts where id = %d', $_GET['id']));
}
```

### åœ¨åˆ—è¡¨é¡µä¸­ç»‘å®šå•æ¡åˆ é™¤é“¾æ¥

`post.php`

```php
<td class="text-center">
  <a href="javascript:;" class="btn btn-default btn-xs">ç¼–è¾‘</a>
  <a href="/admin/post-delete.php?id=<?php echo $item['id']; ?>" class="btn btn-danger btn-xs">åˆ é™¤</a>
</td>
```

### è·³è½¬åˆ°æ¥æº

ç›®å‰è¿™ç§æƒ…å†µï¼Œç”¨æˆ·åœ¨ç‚¹å‡»åˆ é™¤é“¾æ¥åˆ é™¤æŒ‡å®šå†…å®¹åï¼Œéœ€è¦æ‰‹åŠ¨è¿”å›åˆ°ä¹‹å‰çš„é¡µé¢ï¼Œä½“éªŒä¸ä½³ï¼Œæœ€å¥½æ˜¯èƒ½åœ¨ `post-delete.php` æ‰§è¡Œå®Œæˆè¿‡åï¼Œè‡ªåŠ¨è·³è½¬åˆ°ä¹‹å‰è®¿é—®çš„é¡µé¢ï¼Œä¹Ÿå°±æ˜¯æ¥æºé¡µé¢ã€‚

é‚£ä¹ˆå¦‚ä½•è·å–æ¥æºé¡µé¢çš„åœ°å€ï¼Œå°±æ˜¯æˆ‘ä»¬æ¥ä¸‹æ¥çš„é‡ç‚¹ï¼š

#### HTTP Referer

åœ¨ HTTP åè®®ä¸­çº¦å®šï¼šåœ¨è¯·æ±‚å¤´ä¸­åŒ…å«ä¸€ä¸ª `Referer` å­—æ®µï¼Œå€¼å°±æ˜¯ä¸Šä¸€æ¬¡è®¿é—®çš„ URL

```sequence
å®¢æˆ·ç«¯->æœåŠ¡ç«¯: è¯·æ±‚ http://example.com/a.html
æœåŠ¡ç«¯->å®¢æˆ·ç«¯: å“åº” http://example.com/a.html
Note left of å®¢æˆ·ç«¯: ç‚¹å‡» a.html ä¸­çš„\nb.html é¡µé¢é“¾æ¥
å®¢æˆ·ç«¯->æœåŠ¡ç«¯: è¯·æ±‚ http://example.com/b.html
Note right of æœåŠ¡ç«¯: Referer: \nhttp://example.com/a.html
æœåŠ¡ç«¯->å®¢æˆ·ç«¯: å“åº” http://example.com/b.html
```

#### è·å– Referer å¹¶è·³è½¬

åœ¨ PHP ä¸­å¯ä»¥é€šè¿‡ `$_SERVER['HTTP_REFERER']` è·å–åˆ° `Referer`

```php
// è·å–åˆ é™¤åè·³è½¬åˆ°çš„ç›®æ ‡é“¾æ¥ï¼Œä¼˜å…ˆè·³è½¬åˆ°æ¥æºé¡µé¢ï¼Œå¦åˆ™è·³è½¬åˆ°æ–‡ç« åˆ—è¡¨
$target = isset($_SERVER['HTTP_REFERER']) ? $_SERVER['HTTP_REFERER'] : 'posts.php';
// è·³è½¬
header('Location: ' . $target);
```

------

## å¤šé€‰æ‰¹é‡åˆ é™¤

### è®© `post-delete.php` æ”¯æŒæ‰¹é‡åˆ é™¤

ç›®å‰ `post-delete.php` åªèƒ½åˆ é™¤æŒ‡å®šçš„å•ä¸ªæ•°æ®ï¼Œå¦‚æœéœ€è¦æ”¯æŒæ‰¹é‡åˆ é™¤ï¼Œå¯ä»¥ç¨åŠ æ”¹é€ ï¼š

1. çº¦å®šæ¥æ”¶çš„ `id` å‚æ•°æ˜¯ä¸€ä¸ªä»¥è‹±æ–‡åŠè§’é€—å·åˆ†éš”çš„ ID
2. å°†åˆ é™¤ SQL è¯­å¥çš„ `where` å­å¥æ”¹ä¸º `where id in (' . $id . ')`

```php
// $id => 22 / 22,23,24
$rows = xiu_execute('delete from posts where id in (' . $id . ');');
// $sql => delete from posts where id in (22)
// $sql => delete from posts where id in (22,23,24)
```

### é€‰ä¸­çŠ¶æ€åˆ‡æ¢è¿‡ç¨‹åˆ é™¤æŒ‰é’®çš„å˜æ¢

1. å½“é€‰ä¸­ä»»æ„è¡Œè¿‡åï¼Œæ˜¾ç¤ºåˆ é™¤æŒ‰é’®
2. å½“ä»»æ„è¡Œæ”¹å˜é€‰ä¸­çŠ¶æ€è¿‡åï¼Œæ”¹å˜åˆ é™¤æŒ‰é’®çš„é“¾æ¥åœ°å€

å¯¹äºç•Œé¢åŠŸèƒ½éœ€æ±‚ï¼Œå¯ä»¥é€šè¿‡ JavaScript å®ç°ï¼Œå…·ä½“é€»è¾‘å¦‚ä¸‹ï¼š

```flow
s=>start: å¼€å§‹
o1=>operation: å®šä¹‰ä¸€ä¸ªæ•°ç»„ç”¨äºè®°å½•æ‰€æœ‰é€‰ä¸­è¡Œçš„ ID
o2=>operation: ç›‘å¬æ¯ä¸€è¡Œæ•°æ®çš„é€‰ä¸­çŠ¶æ€å˜åŒ–
o3=>operation: è·å–å½“å‰è¡Œå¯¹åº”çš„æ•°æ® ID
c1=>condition: åˆ¤æ–­æ˜¯å¦ä¸ºé€‰ä¸­æ“ä½œ
o4=>operation: å°†å½“å‰è¡Œ ID æ·»åŠ åˆ°æ•°ç»„ä¸­
o5=>operation: å°†å½“å‰è¡Œ ID ä»æ•°ç»„ä¸­ç§»é™¤
c2=>condition: æ˜¯å¦æœ‰ä»»æ„è¡Œè¢«é€‰ä¸­
o6=>operation: æ˜¾ç¤ºåˆ é™¤æŒ‰é’®
o7=>operation: éšè—åˆ é™¤æŒ‰é’®
o8=>operation: é‡æ–°æ‹¼æ¥åˆ é™¤é“¾æ¥ URL

s->o1->o2->o3->c1
c1(yes)->o4->c2
c1(no)->o5->c2
c2(yes)->o6->o8
c2(no)->o7->o8
o8(left)->o2
```

ä»¥ä¸‹æ˜¯æˆ‘æä¾›çš„ä¸€ç§å®ç°ï¼Œåœ¨é¡µé¢ä¸­åŠ å…¥ä¸€æ®µ JavaScript å®Œæˆä¸Šè¿°é€»è¾‘ï¼š

```js
// è·å–æ‰€éœ€æ“ä½œçš„ç•Œé¢å…ƒç´ 
var $btnDelete = $('.btn-delete')
var $tdCheckbox = $('td > input[type=checkbox]')

// ç”¨äºè®°å½•ç•Œé¢ä¸Šé€‰ä¸­è¡Œçš„æ•°æ® ID
var checked = []

/**
 * è¡¨æ ¼ä¸­çš„å¤é€‰æ¡†é€‰ä¸­å‘ç”Ÿæ”¹å˜æ—¶æ§åˆ¶åˆ é™¤æŒ‰é’®çš„é“¾æ¥å‚æ•°å’Œæ˜¾ç¤ºçŠ¶æ€
 */
$tdCheckbox.on('change', function () {
  var $this = $(this)

  // ä¸ºäº†å¯ä»¥åœ¨è¿™é‡Œè·å–åˆ°å½“å‰è¡Œå¯¹åº”çš„æ•°æ® ID
  // åœ¨æœåŠ¡ç«¯æ¸²æŸ“ HTML æ—¶ï¼Œç»™æ¯ä¸€ä¸ª tr æ·»åŠ  data-id å±æ€§ï¼Œè®°å½•æ•°æ® ID
  // è¿™é‡Œé€šè¿‡ data-id å±æ€§è·å–åˆ°å¯¹åº”çš„æ•°æ® ID
  var id = parseInt($this.parent().parent().data('id'))

  // ID å¦‚æœä¸åˆç†å°±å¿½ç•¥
  if (!id) return

  if ($this.prop('checked')) {
    // é€‰ä¸­å°±è¿½åŠ åˆ°æ•°ç»„ä¸­
    checked.push(id)
  } else {
    // æœªé€‰ä¸­å°±ä»æ•°ç»„ä¸­ç§»é™¤
    checked.splice(checked.indexOf(id), 1)
  }

  // æœ‰é€‰ä¸­å°±æ˜¾ç¤ºæ“ä½œæŒ‰é’®ï¼Œæ²¡é€‰ä¸­å°±éšè—
  checked.length ? $btnDelete.fadeIn() : $btnDelete.fadeOut()

  // æ‰¹é‡åˆ é™¤æŒ‰é’®é“¾æ¥å‚æ•°
  // search æ˜¯ DOM æ ‡å‡†å±æ€§ï¼Œç”¨äºè®¾ç½®æˆ–è·å–åˆ°çš„æ˜¯ a é“¾æ¥çš„æŸ¥è¯¢å­—ç¬¦ä¸²
  $btnDelete.prop('search', '?id=' + checked.join(','))
})
```

### å…¨é€‰å’Œå…¨ä¸é€‰

```js
/**
 * å…¨é€‰ / å…¨ä¸é€‰
 */
$thCheckbox.on('change', function () {
  var checked = $(this).prop('checked')
  // è®¾ç½®æ¯ä¸€è¡Œçš„é€‰ä¸­çŠ¶æ€å¹¶è§¦å‘ ä¸Šé¢ ğŸ‘† çš„äº‹ä»¶
  $tdCheckbox.prop('checked', checked).trigger('change')
})
```

# 